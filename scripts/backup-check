#!/usr/bin/env bash

# ================================================================================
# =                                 BACKUP-CHECK                                 =
# ================================================================================

# Comprehensive backup integrity and health check
# - Verifies repository integrity
# - Lists recent snapshots
# - Checks for missing expected backups

set -euo pipefail

echo "=================================="
echo "    Backup Integrity Check"
echo "=================================="
echo ""

# Expected tags
EXPECTED_TAGS=(
  "bash"
  "direnv"
  "icos"
  "ipython"
  "nvim"
  "packages"
  "powershell"
  "python"
  "sql"
  "vault"
  "wt"
  "zellij"
  "zshrc"
)

check_repo() {
  local repo=$1
  local name=$2

  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "  $name Repository"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""

  # 1. Check repository integrity
  echo "Checking repository integrity..."
  if restic -r "$repo" check --read-data-subset=5%; then
    echo "[OK] Repository integrity: PASSED"
  else
    echo "[FAIL] Repository integrity: FAILED"
    return 1
  fi
  echo ""

  # 2. Show repository stats
  echo "Repository statistics:"
  restic -r "$repo" stats --mode=raw-data
  echo ""

  # 3. List recent snapshots (last 7 days)
  echo "Recent snapshots (last 7 days):"
  restic -r "$repo" snapshots --latest 1 --group-by tags
  echo ""

  # 4. Check for missing tags
  echo "Checking for expected backup tags..."
  missing_tags=()
  for tag in "${EXPECTED_TAGS[@]}"; do
    if ! restic -r "$repo" snapshots --tag "$tag" --latest 1 &>/dev/null; then
      missing_tags+=("$tag")
    fi
  done

  if [ ${#missing_tags[@]} -eq 0 ]; then
    echo "[OK] All expected backup tags found"
  else
    echo "[WARN] Missing backup tags:"
    for tag in "${missing_tags[@]}"; do
      echo "  - $tag"
    done
  fi
  echo ""

  # 5. Check for stale backups (older than 7 days)
  echo "Checking for stale backups (>7 days old)..."
  stale_tags=()
  for tag in "${EXPECTED_TAGS[@]}"; do
    last_backup=$(restic -r "$repo" snapshots --tag "$tag" --latest 1 --json 2>/dev/null | jq -r '.[0].time // empty')
    if [ -n "$last_backup" ]; then
      backup_date=$(date -d "$last_backup" +%s)
      current_date=$(date +%s)
      days_old=$(((current_date - backup_date) / 86400))

      if [ $days_old -gt 7 ]; then
        stale_tags+=("$tag ($days_old days old)")
      fi
    fi
  done

  if [ ${#stale_tags[@]} -eq 0 ]; then
    echo "[OK] All backups are recent"
  else
    echo "[WARN] Stale backups found:"
    for tag in "${stale_tags[@]}"; do
      echo "  - $tag"
    done
  fi
  echo ""
}

# Check both repositories
check_repo "$R1" "Local (Pi)"
check_repo "$R2" "Cloud (B2)"

echo "=================================="
echo "    Check Complete"
echo "=================================="
